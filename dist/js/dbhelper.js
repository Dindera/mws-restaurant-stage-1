const dbPromise=idb.open("restaurant-db",4,function(e){switch(e.oldVersion){case 0:e.createObjectStore("restaurant-store",{keyPath:"id"}).createIndex("restaurantIndex","is_favorite");case 1:e.createObjectStore("review-store",{keyPath:"id"}).createIndex("reviewIndex","restaurant_id"),e.createObjectStore("favorite-store",{keyPath:"is_favorite"});case 2:e.createObjectStore("offline-store",{keyPath:"name",autoIncrement:!0}).createIndex("offlineIndex","restaurant_id")}});class DBHelper{static get DATABASE_URL(){return"http://localhost:1337"}static fetchRestaurants(e){function t(){dbPromise.then(e=>e.transaction("restaurant-store").objectStore("restaurant-store").getAll()).then(t=>e(null,t))}fetch(`${DBHelper.DATABASE_URL}/restaurants/`).then(function(e){return e.json()}).then(e=>(dbPromise.then(t=>{const r=t.transaction("restaurant-store","readwrite"),n=r.objectStore("restaurant-store");for(const t of e)n.put(t);return r.complete}),e)).then(function(t){return e(null,t)}).catch(()=>t())}static fetchReviews(e,t){fetch(`${DBHelper.DATABASE_URL}/reviews/?restaurant_id=${+e}`).then(function(e){return e.json()}).then(e=>(dbPromise.then(t=>{const r=t.transaction("review-store","readwrite"),n=r.objectStore("review-store");for(const t of e)n.put(t);return r.complete}),e)).then(function(e){return dbPromise.then(e=>{e.transaction("review-store","readwrite").objectStore("review-store").index("reviewIndex").openCursor().then(e=>e.advance(15)).then(function e(t){t&&(t.delete(),t.continue().then(e))})}),t(null,e)}).catch(()=>dbPromise.then(r=>r.transaction("review-store").objectStore("review-store").index("reviewIndex").getAll(IDBKeyRange.only(+e)).then(e=>{console.log(null,e),t(null,e)}))&&dbPromise.then(e=>e.transaction("offline-store").objectStore("offline-store").index("offlineIndex").getAll().then(e=>{console.log(null,e),t(null,e)})))}static fetchRestaurantById(e,t){DBHelper.fetchRestaurants((r,n)=>{if(r)t(r,null);else{const r=n.find(t=>t.id==e);r?t(null,r):t("Restaurant does not exist",null)}})}static fetchReviewById(e,t){DBHelper.fetchReviews((r,n)=>{if(r)t(r,null);else{const r=n.find(t=>t.id==e);r?t(null,r):t("Review does not exist",null)}})}static fetchRestaurantByCuisine(e,t){DBHelper.fetchRestaurants((r,n)=>{if(r)t(r,null);else{const r=n.filter(t=>t.cuisine_type==e);t(null,r)}})}static fetchRestaurantByNeighborhood(e,t){DBHelper.fetchRestaurants((r,n)=>{if(r)t(r,null);else{const r=n.filter(t=>t.neighborhood==e);t(null,r)}})}static fetchRestaurantByCuisineAndNeighborhood(e,t,r){DBHelper.fetchRestaurants((n,s)=>{if(n)r(n,null);else{let n=s;"all"!=e&&(n=n.filter(t=>t.cuisine_type==e)),"all"!=t&&(n=n.filter(e=>e.neighborhood==t)),r(null,n)}})}static fetchNeighborhoods(e){DBHelper.fetchRestaurants((t,r)=>{if(t)e(t,null);else{const t=r.map((e,t)=>r[t].neighborhood),n=t.filter((e,r)=>t.indexOf(e)==r);e(null,n)}})}static fetchCuisines(e){DBHelper.fetchRestaurants((t,r)=>{if(t)e(t,null);else{const t=r.map((e,t)=>r[t].cuisine_type),n=t.filter((e,r)=>t.indexOf(e)==r);e(null,n)}})}static urlForRestaurant(e){return`./restaurant.html?id=${e.id}`}static imageUrlForRestaurant(e){return`/src/img/${e.id}-300_small.jpg`}static imageSrcsetForIndex(e){return`src/images/${e.id}-300_small.jpg 1x, src/images/${e.id}-600_medium_2x.jpg 2x`}static imageSrcsetForRestaurant(e){return`src/images/${e.id}-300_small.jpg 300w, src/images/${e.id}-600_medium_2x.jpg 600w, src/images/${e.id}-800_large_2x.jpg 800w`}static saveFavorite(e,t){const r=`${DBHelper.DATABASE_URL}/restaurants/${e}/?is_favorite=${t}`;DBHelper.fetchRestaurantById(e,(e,n)=>{e||(n.is_favorite=t,console.log(t),dbPromise.then(e=>{const s=e.transaction("restaurant-store","readwrite"),a=s.objectStore("restaurant-store");return console.log(r),a.put(n).then(e=>{console.log(s),console.log(t),console.log(r),console.log(n.is_favorite),fetch(r,{method:"PUT"})}),s.complete&&n}).catch(e=>(DBHelper.fetchRestaurants(e=>dbPromise.then(t=>{const r=t.transaction("restaurant-store","readwrite").objectStore("restaurant-store").index("restaurantIndex","readwrite").getAll("is_favorite");return console.log(null,r),e(null,r)})),console.log(n.is_favorite),n.is_favorite)))})}static mapMarkerForRestaurant(e,t){const r=new L.marker([e.latlng.lat,e.latlng.lng],{title:e.name,alt:e.name,url:DBHelper.urlForRestaurant(e)});return r.addTo(newMap),r}}
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImRiaGVscGVyLmpzIl0sIm5hbWVzIjpbImRiUHJvbWlzZSIsImlkYiIsIm9wZW4iLCJ1cGdyYWRlREIiLCJrZXlQYXRoIiwib2xkVmVyc2lvbiIsImNyZWF0ZUluZGV4IiwiY3JlYXRlT2JqZWN0U3RvcmUiLCJyZXZpZXdTdG9yZSIsImF1dG9JbmNyZW1lbnQiLCJvZmZsaW5lU3RvcmUiLCJEQVRBQkFTRV9VUkwiLCJbb2JqZWN0IE9iamVjdF0iLCJjYWxsYmFjayIsImZ1bGZpbGxSZXN1bHQiLCJ0aGVuIiwiZGIiLCJ0cmFuc2FjdGlvbiIsImZldGNoUmVzdGF1cmFudHMiLCJnZXREYkRhdGEiLCJyZXN0YXVyYW50cyIsImZldGNoIiwiREJIZWxwZXIiLCJyZXNwb25zZSIsImpzb24iLCJ0eCIsIm9iamVjdFN0b3JlIiwicmVzdGF1cmFudCIsInJlc3RhdXJhbnRTdG9yZSIsImNvbXBsZXRlIiwiY2F0Y2giLCJpZCIsInJldmlld3MiLCJyZXZpZXciLCJmZXRjaFJldmlld3MiLCJjb3VudEN1cnNvciIsImluZGV4Iiwib3BlbkN1cnNvciIsImN1cnNvciIsInN0b3JlIiwiY29udGludWUiLCJkZWxldGVSZXN0IiwiZ2V0QWxsIiwib25seSIsImNvbnNvbGUiLCJvZmZSZXZpZXdzIiwiZXJyb3IiLCJmZXRjaFJlc3RhdXJhbnRCeUlkIiwiciIsImNiIiwiZmluZCIsImZldGNoUmV2aWV3QnlJZCIsImN1aXNpbmUiLCJyZXN1bHRzIiwiZmlsdGVyIiwiY3Vpc2luZV90eXBlIiwibmVpZ2hib3Job29kIiwibmVpZ2hib3Job29kcyIsIm1hcCIsInYiLCJpIiwidW5pcXVlTmVpZ2hib3Job29kcyIsImluZGV4T2YiLCJmZXRjaE5laWdoYm9yaG9vZHMiLCJjdWlzaW5lcyIsInVuaXF1ZUN1aXNpbmVzIiwiaXNmYXZvcml0ZSIsInVybCIsImlzX2Zhdm9yaXRlIiwibG9nIiwiaW1hZ2VTcmNzZXRGb3JSZXN0YXVyYW50IiwicHV0IiwibWV0aG9kIiwiZmF2cyIsIkwiLCJtYXJrZXIiLCJsYXRsbmciLCJsYXQiLCJsbmciLCJ0aXRsZSIsIm5hbWUiLCJhbHQiLCJhZGRUbyIsIm5ld01hcCJdLCJtYXBwaW5ncyI6IkFBZUksTUFBQUEsVUFBQUMsSUFBQUMsS0FBQSxnQkFBQSxFQUFBLFNBQUFDLEdBQzBFQyxPQUFBQSxFQUFTQyxZQUFYLEtBQXZFLEVBQ2dCQyxFQUFZQyxrQkFBbUIsbUJBQS9DLENBQUFILFFBQUEsT0FBZ0JFLFlBQVksa0JBQW1CLGVBQy9DLEtBQUEsRUFDbUJILEVBQVVJLGtCQUFrQixlQUFnQixDQUFBSCxRQUFBLE9BQVdFLFlBQUEsY0FBQSxpQkFBWEgsRUFBOURJLGtCQUFBLGlCQUFBLENBQUFILFFBQUEsZ0JBQ0FJLEtBQUFBLEVBQ1VELEVBQWtCQSxrQkFBa0IsZ0JBQUEsQ0FBQUgsUUFBQSxPQUFBSyxlQUFBLElBQVdILFlBQUEsZUFBQSxvQkFHdkRJLE1BQUFBLFNBYU5DLDBCQUpBLE1BQUEsd0JBaUJBQyx3QkFBd0JDLEdBTW5CLFNBSkRDLElBQU9kLFVBQVVlLEtBQUtDLEdBQ1RBLEVBQUdDLFlBQVksb0JBSHpCQyxZQUFBQSxvQkFDSUMsVUFNUkosS0FBQUssR0FJVVAsRUFBUyxLQUFNTyxJQUV6QkMsU0FFTEMsU0FBQVgsNkJBRU9JLEtBQUssU0FBVVEsR0FEbEJGLE9BRXdCRSxFQUFTQyxTQUE3QlQsS0FBTUssSUFDTnBCLFVBQU9vQixLQUFBQSxJQUNOTCxNQUFLSyxFQUFBQSxFQUFXSCxZQUFJLG1CQUFBLGFBQ1hGLEVBQVdVLEVBQUFDLFlBQUEsb0JBQ25CLElBQU1ELE1BQU9FLEtBQWFQLEVBQzFCUSxFQUFNQSxJQUFrQkgsR0FDeEIsT0FBS0EsRUFBTUUsV0FFVlAsSUFJRkwsS0FBSyxTQUFVSyxHQUhkLE9BQU9LLEVBQUdJLEtBQVZULEtBTkZVLE1BQUEsSUFRT1YsS0FJUFIsb0JBQU9FLEVBQWFELEdBMENyQlEsU0FUREMsU0FBQVgsd0NBQUFvQixLQVVEaEIsS0FBQSxTQUFBUSxHQUdERixPQUVvQkUsRUFBU0MsU0FB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QVEsVUFsQlQvQyxFQUFJSSxVQUFXbEIsSUFzQmpCbUIsTUFBT2pCLElBbEJWUyxTQUFVSixpQkFBQUwsR0FDVmMsVUFBV3lDLEtBQVhwRCxJQUNBNEIsTUFJVXlCLEVBSkVILEVBQUFBLFlBQVosbUJBQUEsYUFFNEJ4QyxZQUFBLG9CQUNDQSxNQUFZLGtCQUF2QyxhQUNBZ0IsT0FBQSxlQUlFRSxPQURBQSxRQUFReUIsSUFBUixLQUFBSSxHQUNRSixFQUFJSCxLQUFaTyxNQUdBcEQsUUFBQUEsSUFBTThDLEVBQUtDLGFBQ1RJLEVBQVFKLGlCQVdSeEQsOEJBQWNnQixFQUFnQlEsR0FHOUJRLE1BQUFBLEVBQU8sSUFBUDhCLEVBQVlDLE9BQU1GLENBQUFBLEVBQWxCRyxPQUFBQyxJQUFBbEQsRUFBQWlELE9BQUFFLEtBQ0QsQ0FDREMsTUFUSHBELEVBQUFxRCxLQVVFQyxJQVhEdEQsRUFBQXFELEtBWUZwQyxJQUFBQSxTQUFZakIsaUJBQVd5QyxLQUcxQixPQURFTyxFQS9CQ08sTUFBQUMsUUFKRlIiLCJmaWxlIjoiZGJoZWxwZXIuanMiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBleHBvcnQgZGVmYXVsdCBEQkhlbHBlclxyXG5cclxuXHJcbihmdW5jdGlvbiAoKSB7XHJcbiAgJ3VzZSBzdHJpY3QnXHJcblxyXG4gIGlmICghKCdpbmRleGVkREInIGluIHdpbmRvdykpIHtcclxuICAgIGNvbnNvbGUubG9nKCdUaGlzIGJyb3dzZXIgZG9lc25cXCd0IHN1cHBvcnQgSW5kZXhlZERCJyk7XHJcbiAgICByZXR1cm47XHJcbiAgfVxyXG59KTtcclxuXHJcbmNvbnN0IGRiUHJvbWlzZSA9IGlkYi5vcGVuKCdyZXN0YXVyYW50LWRiJywgNCwgZnVuY3Rpb24gKHVwZ3JhZGVEQikge1xyXG5cclxuICBzd2l0Y2ggKHVwZ3JhZGVEQi5vbGRWZXJzaW9uKSB7XHJcbiAgICBjYXNlIDA6XHJcbiAgICAgbGV0IHJlc3RhdXJhbnRTdG9yZSA9ICB1cGdyYWRlREIuY3JlYXRlT2JqZWN0U3RvcmUoJ3Jlc3RhdXJhbnQtc3RvcmUnLCB7IGtleVBhdGg6ICdpZCcgfSk7XHJcbiAgICAgcmVzdGF1cmFudFN0b3JlLmNyZWF0ZUluZGV4KCdyZXN0YXVyYW50SW5kZXgnLCAnaXNfZmF2b3JpdGUnKTtcclxuICAgICBjYXNlIDE6XHJcbiAgICAgIGxldCByZXZpZXdTdG9yZSA9IHVwZ3JhZGVEQi5jcmVhdGVPYmplY3RTdG9yZSgncmV2aWV3LXN0b3JlJywgeyBrZXlQYXRoOiAnaWQnIH0pO1xyXG4gICAgICByZXZpZXdTdG9yZS5jcmVhdGVJbmRleCgncmV2aWV3SW5kZXgnLCAncmVzdGF1cmFudF9pZCcpO1xyXG4gICAgICB1cGdyYWRlREIuY3JlYXRlT2JqZWN0U3RvcmUoJ2Zhdm9yaXRlLXN0b3JlJywgeyBrZXlQYXRoOiAnaXNfZmF2b3JpdGUnIH0pO1xyXG4gICAgICBjYXNlIDI6IFxyXG4gICAgICBsZXQgb2ZmbGluZVN0b3JlID0gdXBncmFkZURCLmNyZWF0ZU9iamVjdFN0b3JlKCdvZmZsaW5lLXN0b3JlJywge2tleVBhdGg6ICduYW1lJywgYXV0b0luY3JlbWVudDogdHJ1ZX0pO1xyXG4gICAgICAgIG9mZmxpbmVTdG9yZS5jcmVhdGVJbmRleCgnb2ZmbGluZUluZGV4JywgJ3Jlc3RhdXJhbnRfaWQnKTtcclxuICB9XHJcblxyXG59KTtcclxuXHJcbi8qKlxyXG4gKiBDb21tb24gZGF0YWJhc2UgaGVscGVyIGZ1bmN0aW9ucy5cclxuICovXHJcbmNsYXNzIERCSGVscGVyIHtcclxuICAvKipcclxuICAgICAqIERhdGFiYXNlIFVSTC5cclxuICAgICAqIENoYW5nZSB0aGlzIHRvIHJlc3RhdXJhbnRzLmpzb24gZmlsZSBsb2NhdGlvbiBvbiB5b3VyIHNlcnZlci5cclxuICAgICAqL1xyXG4gIHN0YXRpYyBnZXQgREFUQUJBU0VfVVJMKCkge1xyXG4gICAgY29uc3QgcG9ydCA9IDEzMzcgLy8gQ2hhbmdlIHRoaXMgdG8geW91ciBzZXJ2ZXIgcG9ydFxyXG5cclxuICAgIHJldHVybiBgaHR0cDovL2xvY2FsaG9zdDoke3BvcnR9YDtcclxuXHJcbiAgICAvLyByZXR1cm4gYGh0dHBzOi8vZGluZGVyYS5naXRodWIuaW8vJHtwb3J0fS9kYXRhL3Jlc3RhdXJhbnRzLmpzb25gO1xyXG4gIH1cclxuXHJcblxyXG4gIC8qKlxyXG4gICAqIEZldGNoIGFsbCByZXN0YXVyYW50cy5cclxuICAgKi9cclxuXHJcbiAgc3RhdGljIGZldGNoUmVzdGF1cmFudHMoY2FsbGJhY2spIHtcclxuICAgIGZ1bmN0aW9uIGdldERiRGF0YSgpIHtcclxuICAgICAgcmV0dXJuIGRiUHJvbWlzZS50aGVuKGRiID0+IHtcclxuICAgICAgICBjb25zdCB0eCA9IGRiLnRyYW5zYWN0aW9uKCdyZXN0YXVyYW50LXN0b3JlJylcclxuICAgICAgICAgIC5vYmplY3RTdG9yZSgncmVzdGF1cmFudC1zdG9yZScpO1xyXG4gICAgICAgIHJldHVybiB0eC5nZXRBbGwoKTtcclxuICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gZnVsZmlsbFJlc3VsdCgpIHtcclxuICAgICAgZ2V0RGJEYXRhKCkudGhlbihyZXN0YXVyYW50cyA9PiB7XHJcbiAgICAgICAgcmV0dXJuIGNhbGxiYWNrKG51bGwsIHJlc3RhdXJhbnRzKTtcclxuICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4vLyBmZXRjaCBSZXN0YXVyYW50XHJcbiAgICBmZXRjaChgJHtEQkhlbHBlci5EQVRBQkFTRV9VUkx9L3Jlc3RhdXJhbnRzL2ApXHJcbiAgICAgIC50aGVuKGZ1bmN0aW9uIChyZXNwb25zZSkge1xyXG4gICAgICAgIGNvbnN0IHJlc3RhdXJhbnRzID0gcmVzcG9uc2UuanNvbigpO1xyXG4gICAgICAgIHJldHVybiByZXN0YXVyYW50cztcclxuICAgICAgfSkudGhlbihyZXN0YXVyYW50cyA9PiB7XHJcbiAgICAgICAgZGJQcm9taXNlLnRoZW4oZGIgPT4ge1xyXG4gICAgICAgICAgY29uc3QgdHggPSBkYi50cmFuc2FjdGlvbigncmVzdGF1cmFudC1zdG9yZScsICdyZWFkd3JpdGUnKTtcclxuICAgICAgICAgIGNvbnN0IHJlc3RhdXJhbnRTdG9yZSA9IHR4Lm9iamVjdFN0b3JlKCdyZXN0YXVyYW50LXN0b3JlJyk7XHJcbiAgICAgICAgICBmb3IgKGNvbnN0IHJlc3RhdXJhbnQgb2YgcmVzdGF1cmFudHMpIHtcclxuICAgICAgICAgICAgcmVzdGF1cmFudFN0b3JlLnB1dChyZXN0YXVyYW50KTtcclxuICAgICAgICAgIH1cclxuICAgICAgICAgIHJldHVybiB0eC5jb21wbGV0ZTtcclxuICAgICAgICB9KVxyXG4gICAgICAgIHJldHVybiByZXN0YXVyYW50cztcclxuICAgICAgfSkudGhlbihmdW5jdGlvbiAocmVzdGF1cmFudHMpIHtcclxuICAgICAgICByZXR1cm4gY2FsbGJhY2sobnVsbCwgcmVzdGF1cmFudHMpO1xyXG4gICAgICB9KS5jYXRjaCgoKSA9PiB7XHJcbiAgICAgICAgcmV0dXJuIGZ1bGZpbGxSZXN1bHQoKTtcclxuICAgICAgfSk7XHJcbiAgfVxyXG5cclxuICBzdGF0aWMgZmV0Y2hSZXZpZXdzKGlkLCBjYWxsYmFjaykge1xyXG5cclxuICAgIGZ1bmN0aW9uIGNvdW50Q3Vyc29yKCkgIHtcclxuICAgICAgZGJQcm9taXNlLnRoZW4oZGI9PiB7XHJcbiAgICAgICAgbGV0IHR4ID0gZGIudHJhbnNhY3Rpb24oJ3Jldmlldy1zdG9yZScsICdyZWFkd3JpdGUnKTtcclxuICAgICAgICBsZXQgc3RvcmUgPSB0eC5vYmplY3RTdG9yZSgncmV2aWV3LXN0b3JlJyk7XHJcbiAgICAgICAgIHN0b3JlLmluZGV4KCdyZXZpZXdJbmRleCcpLm9wZW5DdXJzb3IoKS50aGVuKGN1cnNvcj0+IHtcclxuICAgICAgICAgICByZXR1cm4gY3Vyc29yLmFkdmFuY2UoMTUpO1xyXG4gICAgICAgICB9KS50aGVuKGZ1bmN0aW9uIGRlbGV0ZVJlc3QoY3Vyc29yKXtcclxuICAgICAgICAgICBpZighY3Vyc29yKSByZXR1cm47XHJcbiAgICAgICAgICAgY3Vyc29yLmRlbGV0ZSgpO1xyXG4gICAgICAgICAgIGN1cnNvci5jb250aW51ZSgpLnRoZW4oZGVsZXRlUmVzdCk7XHJcbiAgICAgICAgIH0pO1xyXG4gICAgICB9KVxyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIGdldE9mbGxpbmVTdG9yZSgpe1xyXG4gICAgICByZXR1cm4gZGJQcm9taXNlLnRoZW4oZGIgPT4ge1xyXG4gICAgICAgIGNvbnN0IHR4ID0gZGIudHJhbnNhY3Rpb24oJ29mZmxpbmUtc3RvcmUnKVxyXG4gICAgICAgIGNvbnN0IG9mZmxpbmVTdG9yZSA9IHR4Lm9iamVjdFN0b3JlKCdvZmZsaW5lLXN0b3JlJyk7XHJcbiAgICAgICAgY29uc3QgaW5kZXggPSBvZmZsaW5lU3RvcmUuaW5kZXgoJ29mZmxpbmVJbmRleCcpO1xyXG4gICAgICAgIHJldHVybiBpbmRleC5nZXRBbGwoKS50aGVuKG9mZlJldmlld3MgPT4ge1xyXG4gICAgICAgICAgY29uc29sZS5sb2cobnVsbCwgb2ZmUmV2aWV3cyk7XHJcbiAgICAgICAgICAgY2FsbGJhY2sobnVsbCwgb2ZmUmV2aWV3cyk7XHJcbiAgICAgICAgfSlcclxuICAgICAgfSlcclxuICAgIH1cclxuICAgIC8vIGRpc3BsYXkgdGhlIHJldmlld3Mgd2hlbiBvZmZsaW5lXHJcbiAgICBmdW5jdGlvbiBnZXREYlJldmlldygpIHtcclxuICAgICAgcmV0dXJuIGRiUHJvbWlzZS50aGVuKGRiID0+IHtcclxuICAgICAgICBjb25zdCB0eCA9IGRiLnRyYW5zYWN0aW9uKCdyZXZpZXctc3RvcmUnKVxyXG4gICAgICAgIGNvbnN0IHJldmlld1N0b3JlID0gdHgub2JqZWN0U3RvcmUoJ3Jldmlldy1zdG9yZScpO1xyXG4gICAgICAgIGNvbnN0IGluZGV4ID0gcmV2aWV3U3RvcmUuaW5kZXgoJ3Jldmlld0luZGV4Jyk7XHJcbiAgICAgICAgLy8gZ2V0IHJlc3RhdXJhbnRfaWQgb2YgYSBzcGVjaWZpYyBudW1iZXJcclxuICAgICAgICByZXR1cm4gaW5kZXguZ2V0QWxsKElEQktleVJhbmdlLm9ubHkoK2lkKSkudGhlbihyZXZpZXdzID0+IHtcclxuICAgICAgICAgICAgY29uc29sZS5sb2cobnVsbCwgcmV2aWV3cylcclxuICAgICAgICAgICBjYWxsYmFjayhudWxsLCByZXZpZXdzKTtcclxuICAgICAgICAgIH0pOyBcclxuICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG5cclxuICAgIGZldGNoKGAke0RCSGVscGVyLkRBVEFCQVNFX1VSTH0vcmV2aWV3cy8/cmVzdGF1cmFudF9pZD0keytpZH1gKVxyXG4gICAgICAudGhlbihmdW5jdGlvbiAocmVzcG9uc2UpIHtcclxuICAgICAgICBjb25zdCByZXZpZXdzID0gcmVzcG9uc2UuanNvbigpO1xyXG4gICAgICAgIHJldHVybiByZXZpZXdzO1xyXG4gICAgICB9KS50aGVuKHJldmlld3MgPT4ge1xyXG4gICAgICAgIGRiUHJvbWlzZS50aGVuKGRiID0+IHtcclxuICAgICAgICAgIC8vc2F2ZSByZXZpZXdzIGluIGRiXHJcbiAgICAgICAgICBjb25zdCB0eCA9IGRiLnRyYW5zYWN0aW9uKCdyZXZpZXctc3RvcmUnLCAncmVhZHdyaXRlJyk7XHJcbiAgICAgICAgICBjb25zdCByZXZpZXdTdG9yZSA9IHR4Lm9iamVjdFN0b3JlKCdyZXZpZXctc3RvcmUnKTtcclxuICAgICAgICAgIGZvciAoY29uc3QgcmV2aWV3IG9mIHJldmlld3MpIHtcclxuICAgICAgICAgICAgcmV2aWV3U3RvcmUucHV0KHJldmlldyk7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgICByZXR1cm4gdHguY29tcGxldGU7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgcmV0dXJuIHJldmlld3M7XHJcbiAgICAgIH0pLnRoZW4oZnVuY3Rpb24gKHJldmlld3MpIHtcclxuICAgICAgICBjb3VudEN1cnNvcigpXHJcbiAgICAgICAgcmV0dXJuIGNhbGxiYWNrKG51bGwsIHJldmlld3MpO1xyXG4gICAgICB9KS5jYXRjaCgoKSA9PiB7XHJcbiAgICAgICAgcmV0dXJuIGdldERiUmV2aWV3KCkgJiYgZ2V0T2ZsbGluZVN0b3JlKCk7XHJcbiAgICAgIH0pO1xyXG4gIH1cclxuXHJcblxyXG4gIC8qKlxyXG4gICAqIEZldGNoIGEgcmVzdGF1cmFudCBieSBpdHMgSUQuXHJcbiAgICovXHJcbiAgc3RhdGljIGZldGNoUmVzdGF1cmFudEJ5SWQoaWQsIGNhbGxiYWNrKSB7XHJcbiAgICAvLyBmZXRjaCBhbGwgcmVzdGF1cmFudHMgd2l0aCBwcm9wZXIgZXJyb3IgaGFuZGxpbmcuXHJcbiAgICBEQkhlbHBlci5mZXRjaFJlc3RhdXJhbnRzKChlcnJvciwgcmVzdGF1cmFudHMpID0+IHtcclxuICAgICAgaWYgKGVycm9yKSB7XHJcbiAgICAgICAgY2FsbGJhY2soZXJyb3IsIG51bGwpO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIGNvbnN0IHJlc3RhdXJhbnQgPSByZXN0YXVyYW50cy5maW5kKHIgPT4gci5pZCA9PSBpZCk7XHJcbiAgICAgICAgaWYgKHJlc3RhdXJhbnQpIHsgLy8gR290IHRoZSByZXN0YXVyYW50XHJcbiAgICAgICAgICBjYWxsYmFjayhudWxsLCByZXN0YXVyYW50KTtcclxuICAgICAgICB9IGVsc2UgeyAvLyBSZXN0YXVyYW50IGRvZXMgbm90IGV4aXN0IGluIHRoZSBkYXRhYmFzZVxyXG4gICAgICAgICAgY2FsbGJhY2soJ1Jlc3RhdXJhbnQgZG9lcyBub3QgZXhpc3QnLCBudWxsKTtcclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAqIEZldGNoIGEgcmV2aWV3IGJ5IGl0cyBJRC5cclxuICovXHJcbiAgc3RhdGljIGZldGNoUmV2aWV3QnlJZChpZCwgY2IpIHtcclxuICAgIC8vIGZldGNoIGFsbCByZXZpZXdzIHdpdGggcHJvcGVyIGVycm9yIGhhbmRsaW5nLlxyXG4gICAgREJIZWxwZXIuZmV0Y2hSZXZpZXdzKChlcnJvciwgcmV2aWV3cykgPT4ge1xyXG4gICAgICBpZiAoZXJyb3IpIHtcclxuICAgICAgICBjYihlcnJvciwgbnVsbCk7XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgY29uc3QgcmV2aWV3ID0gcmV2aWV3cy5maW5kKHIgPT4gci5pZCA9PSBpZCk7XHJcbiAgICAgICAgaWYgKHJldmlldykgeyAvLyBHb3QgdGhlIHJldmlld1xyXG4gICAgICAgICAgY2IobnVsbCwgcmV2aWV3KTtcclxuICAgICAgICB9IGVsc2UgeyAvLyBSZXN0YXVyYW50IGRvZXMgbm90IGV4aXN0IGluIHRoZSBkYXRhYmFzZVxyXG4gICAgICAgICAgY2IoJ1JldmlldyBkb2VzIG5vdCBleGlzdCcsIG51bGwpO1xyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBGZXRjaCByZXN0YXVyYW50cyBieSBhIGN1aXNpbmUgdHlwZSB3aXRoIHByb3BlciBlcnJvciBoYW5kbGluZy5cclxuICAgKi9cclxuICBzdGF0aWMgZmV0Y2hSZXN0YXVyYW50QnlDdWlzaW5lKGN1aXNpbmUsIGNhbGxiYWNrKSB7XHJcbiAgICAvLyBGZXRjaCBhbGwgcmVzdGF1cmFudHMgIHdpdGggcHJvcGVyIGVycm9yIGhhbmRsaW5nXHJcbiAgICBEQkhlbHBlci5mZXRjaFJlc3RhdXJhbnRzKChlcnJvciwgcmVzdGF1cmFudHMpID0+IHtcclxuICAgICAgaWYgKGVycm9yKSB7XHJcbiAgICAgICAgY2FsbGJhY2soZXJyb3IsIG51bGwpO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIC8vIEZpbHRlciByZXN0YXVyYW50cyB0byBoYXZlIG9ubHkgZ2l2ZW4gY3Vpc2luZSB0eXBlXHJcbiAgICAgICAgY29uc3QgcmVzdWx0cyA9IHJlc3RhdXJhbnRzLmZpbHRlcihyID0+IHIuY3Vpc2luZV90eXBlID09IGN1aXNpbmUpO1xyXG4gICAgICAgIGNhbGxiYWNrKG51bGwsIHJlc3VsdHMpO1xyXG4gICAgICB9XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIEZldGNoIHJlc3RhdXJhbnRzIGJ5IGEgbmVpZ2hib3Job29kIHdpdGggcHJvcGVyIGVycm9yIGhhbmRsaW5nLlxyXG4gICAqL1xyXG4gIHN0YXRpYyBmZXRjaFJlc3RhdXJhbnRCeU5laWdoYm9yaG9vZChuZWlnaGJvcmhvb2QsIGNhbGxiYWNrKSB7XHJcbiAgICAvLyBGZXRjaCBhbGwgcmVzdGF1cmFudHNcclxuICAgIERCSGVscGVyLmZldGNoUmVzdGF1cmFudHMoKGVycm9yLCByZXN0YXVyYW50cykgPT4ge1xyXG4gICAgICBpZiAoZXJyb3IpIHtcclxuICAgICAgICBjYWxsYmFjayhlcnJvciwgbnVsbCk7XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgLy8gRmlsdGVyIHJlc3RhdXJhbnRzIHRvIGhhdmUgb25seSBnaXZlbiBuZWlnaGJvcmhvb2RcclxuICAgICAgICBjb25zdCByZXN1bHRzID0gcmVzdGF1cmFudHMuZmlsdGVyKHIgPT4gci5uZWlnaGJvcmhvb2QgPT0gbmVpZ2hib3Job29kKTtcclxuICAgICAgICBjYWxsYmFjayhudWxsLCByZXN1bHRzKTtcclxuICAgICAgfVxyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBGZXRjaCByZXN0YXVyYW50cyBieSBhIGN1aXNpbmUgYW5kIGEgbmVpZ2hib3Job29kIHdpdGggcHJvcGVyIGVycm9yIGhhbmRsaW5nLlxyXG4gICAqL1xyXG4gIHN0YXRpYyBmZXRjaFJlc3RhdXJhbnRCeUN1aXNpbmVBbmROZWlnaGJvcmhvb2QoY3Vpc2luZSwgbmVpZ2hib3Job29kLCBjYWxsYmFjaykge1xyXG4gICAgLy8gRmV0Y2ggYWxsIHJlc3RhdXJhbnRzXHJcbiAgICBEQkhlbHBlci5mZXRjaFJlc3RhdXJhbnRzKChlcnJvciwgcmVzdGF1cmFudHMpID0+IHtcclxuICAgICAgaWYgKGVycm9yKSB7XHJcbiAgICAgICAgY2FsbGJhY2soZXJyb3IsIG51bGwpO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIGxldCByZXN1bHRzID0gcmVzdGF1cmFudHNcclxuICAgICAgICBpZiAoY3Vpc2luZSAhPSAnYWxsJykgeyAvLyBmaWx0ZXIgYnkgY3Vpc2luZVxyXG4gICAgICAgICAgcmVzdWx0cyA9IHJlc3VsdHMuZmlsdGVyKHIgPT4gci5jdWlzaW5lX3R5cGUgPT0gY3Vpc2luZSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmIChuZWlnaGJvcmhvb2QgIT0gJ2FsbCcpIHsgLy8gZmlsdGVyIGJ5IG5laWdoYm9yaG9vZFxyXG4gICAgICAgICAgcmVzdWx0cyA9IHJlc3VsdHMuZmlsdGVyKHIgPT4gci5uZWlnaGJvcmhvb2QgPT0gbmVpZ2hib3Job29kKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgY2FsbGJhY2sobnVsbCwgcmVzdWx0cyk7XHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogRmV0Y2ggYWxsIG5laWdoYm9yaG9vZHMgd2l0aCBwcm9wZXIgZXJyb3IgaGFuZGxpbmcuXHJcbiAgICovXHJcbiAgc3RhdGljIGZldGNoTmVpZ2hib3Job29kcyhjYWxsYmFjaykge1xyXG4gICAgLy8gRmV0Y2ggYWxsIHJlc3RhdXJhbnRzXHJcbiAgICBEQkhlbHBlci5mZXRjaFJlc3RhdXJhbnRzKChlcnJvciwgcmVzdGF1cmFudHMpID0+IHtcclxuICAgICAgaWYgKGVycm9yKSB7XHJcbiAgICAgICAgY2FsbGJhY2soZXJyb3IsIG51bGwpO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIC8vIEdldCBhbGwgbmVpZ2hib3Job29kcyBmcm9tIGFsbCByZXN0YXVyYW50c1xyXG4gICAgICAgIGNvbnN0IG5laWdoYm9yaG9vZHMgPSByZXN0YXVyYW50cy5tYXAoKHYsIGkpID0+IHJlc3RhdXJhbnRzW2ldLm5laWdoYm9yaG9vZClcclxuICAgICAgICAvLyBSZW1vdmUgZHVwbGljYXRlcyBmcm9tIG5laWdoYm9yaG9vZHNcclxuICAgICAgICBjb25zdCB1bmlxdWVOZWlnaGJvcmhvb2RzID0gbmVpZ2hib3Job29kcy5maWx0ZXIoKHYsIGkpID0+IG5laWdoYm9yaG9vZHMuaW5kZXhPZih2KSA9PSBpKVxyXG4gICAgICAgIGNhbGxiYWNrKG51bGwsIHVuaXF1ZU5laWdoYm9yaG9vZHMpO1xyXG4gICAgICB9XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIEZldGNoIGFsbCBjdWlzaW5lcyB3aXRoIHByb3BlciBlcnJvciBoYW5kbGluZy5cclxuICAgKi9cclxuICBzdGF0aWMgZmV0Y2hDdWlzaW5lcyhjYWxsYmFjaykge1xyXG4gICAgLy8gRmV0Y2ggYWxsIHJlc3RhdXJhbnRzXHJcbiAgICBEQkhlbHBlci5mZXRjaFJlc3RhdXJhbnRzKChlcnJvciwgcmVzdGF1cmFudHMpID0+IHtcclxuICAgICAgaWYgKGVycm9yKSB7XHJcbiAgICAgICAgY2FsbGJhY2soZXJyb3IsIG51bGwpO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIC8vIEdldCBhbGwgY3Vpc2luZXMgZnJvbSBhbGwgcmVzdGF1cmFudHNcclxuICAgICAgICBjb25zdCBjdWlzaW5lcyA9IHJlc3RhdXJhbnRzLm1hcCgodiwgaSkgPT4gcmVzdGF1cmFudHNbaV0uY3Vpc2luZV90eXBlKVxyXG4gICAgICAgIC8vIFJlbW92ZSBkdXBsaWNhdGVzIGZyb20gY3Vpc2luZXNcclxuICAgICAgICBjb25zdCB1bmlxdWVDdWlzaW5lcyA9IGN1aXNpbmVzLmZpbHRlcigodiwgaSkgPT4gY3Vpc2luZXMuaW5kZXhPZih2KSA9PSBpKVxyXG4gICAgICAgIGNhbGxiYWNrKG51bGwsIHVuaXF1ZUN1aXNpbmVzKTtcclxuICAgICAgfVxyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuXHJcbiAgLyoqXHJcbiAgICogUmVzdGF1cmFudCBwYWdlIFVSTC5cclxuICAgKi9cclxuICBzdGF0aWMgdXJsRm9yUmVzdGF1cmFudChyZXN0YXVyYW50KSB7XHJcbiAgICByZXR1cm4gKGAuL3Jlc3RhdXJhbnQuaHRtbD9pZD0ke3Jlc3RhdXJhbnQuaWR9YCk7XHJcbiAgICAvLyBjb25zdCB1cmwgPSAnaHR0cHM6Ly9kaW5kZXJhLmdpdGh1Yi5pby9yZXN0YXVyYW50LXJldmlldy1hcHAvJztcclxuICAgIC8vIHJldHVybiAoYC9yZXN0YXVyYW50cy8ke3Jlc3RhdXJhbnQuaWR9YCk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBSZXN0YXVyYW50IGltYWdlIFVSTC5cclxuICAgKi9cclxuICBzdGF0aWMgaW1hZ2VVcmxGb3JSZXN0YXVyYW50KHJlc3RhdXJhbnQpIHtcclxuICAgIHJldHVybiAoYC9zcmMvaW1nLyR7cmVzdGF1cmFudC5pZH0tMzAwX3NtYWxsLmpwZ2ApO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgKiAgSW1hZ2UgU3Jjc2V0IGZvciBJbmRleCBwYWdlLlxyXG4gICovXHJcbiAgc3RhdGljIGltYWdlU3Jjc2V0Rm9ySW5kZXgocmVzdGF1cmFudCkge1xyXG4gICAgcmV0dXJuIChgc3JjL2ltYWdlcy8ke3Jlc3RhdXJhbnQuaWR9LTMwMF9zbWFsbC5qcGcgMXgsIHNyYy9pbWFnZXMvJHtyZXN0YXVyYW50LmlkfS02MDBfbWVkaXVtXzJ4LmpwZyAyeGApO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgKiAgSW1hZ2UgU3Jjc2V0IGZvciBSZXN0YXVyYW50IHBhZ2UuXHJcbiAgKi9cclxuICBzdGF0aWMgaW1hZ2VTcmNzZXRGb3JSZXN0YXVyYW50KHJlc3RhdXJhbnQpIHtcclxuICAgIHJldHVybiAoYHNyYy9pbWFnZXMvJHtyZXN0YXVyYW50LmlkfS0zMDBfc21hbGwuanBnIDMwMHcsIHNyYy9pbWFnZXMvJHtyZXN0YXVyYW50LmlkfS02MDBfbWVkaXVtXzJ4LmpwZyA2MDB3LCBzcmMvaW1hZ2VzLyR7cmVzdGF1cmFudC5pZH0tODAwX2xhcmdlXzJ4LmpwZyA4MDB3YCk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAqIEdldCBGYXZvcml0ZSByZXN0YXVyYW50c1xyXG4gICogLypcclxuKiBNYXJrIGZhdm9yaXRlIHJlc3RhdXJhbnQgYW5kIGFkZCB0byBmYXZvcml0ZSBkYXRhYmFzZSBhbmQgcmVzdGF1cmFudCBkYXRhYmFzZVxyXG4qIEdldCB0aGUgZmF2b3JpdGVzIHdoZW4gb2ZmbGluZSBmcm9tIHJlc3RhdXJudCBkYXRhYnNlIFxyXG4qIHB1dCBmYXZvcml0ZSB3aGVuIG9mZmxpbmUgdG8gZGF0YWJhc2VcclxuKiBzZW5kIGZhdm9yaXRlcyB0byBzZXJ2ZXIgZnJvbSBkYXRhYmFzZSB3aGVuIGNvbm5lY3RlZCB0byBuZXR3b3JrXHJcblxyXG4qL1xyXG5cclxuICBzdGF0aWMgc2F2ZUZhdm9yaXRlKGlkLCBpc2Zhdm9yaXRlLCkge1xyXG5cclxuICBjb25zdCB1cmwgPSBgJHtEQkhlbHBlci5EQVRBQkFTRV9VUkx9L3Jlc3RhdXJhbnRzLyR7aWR9Lz9pc19mYXZvcml0ZT0ke2lzZmF2b3JpdGV9YFxyXG4gICAgIFxyXG4gICAgLy9EQkhlbHBlci5hZGRQZW5kaW5nT2ZmbGluZSh1cmwsIG1ldGhvZClcclxuICAgIERCSGVscGVyLmZldGNoUmVzdGF1cmFudEJ5SWQoaWQsIChlcnJvciwgcmVzdGF1cmFudCkgPT4ge1xyXG4gICAgICBpZihlcnJvcikgcmV0dXJuO1xyXG4gICAgICByZXN0YXVyYW50LmlzX2Zhdm9yaXRlID0gaXNmYXZvcml0ZTtcclxuICAgICAgY29uc29sZS5sb2coaXNmYXZvcml0ZSk7XHJcbiAgICAgIGRiUHJvbWlzZS50aGVuKGRiID0+IHtcclxuICAgICAgICBjb25zdCB0eCA9IGRiLnRyYW5zYWN0aW9uKCdyZXN0YXVyYW50LXN0b3JlJywgJ3JlYWR3cml0ZScpO1xyXG4gICAgICAgIGNvbnN0IHJlc3RhdXJhbnRTdG9yZSA9IHR4Lm9iamVjdFN0b3JlKCdyZXN0YXVyYW50LXN0b3JlJyk7XHJcbiAgICAgICAgY29uc29sZS5sb2codXJsKTtcclxuICAgICAgICBcclxuICAgICAgICByZXN0YXVyYW50U3RvcmUucHV0KHJlc3RhdXJhbnQpLnRoZW4oaWQgPT4ge1xyXG4gICAgICAgICAgY29uc29sZS5sb2codHgpO1xyXG4gICAgICAgICAgY29uc29sZS5sb2coaXNmYXZvcml0ZSk7XHJcbiAgICAgICAgICBjb25zb2xlLmxvZyh1cmwpO1xyXG4gICAgICAgICAgY29uc29sZS5sb2cocmVzdGF1cmFudC5pc19mYXZvcml0ZSk7XHJcbiAgICAgICAgICBmZXRjaCh1cmwsIHtcclxuICAgICAgICAgICAgbWV0aG9kOiAnUFVUJ1xyXG4gICAgICAgICAgfSlcclxuICAgICAgICB9KTtcclxuICAgICAgICByZXR1cm4gdHguY29tcGxldGUgJiYgcmVzdGF1cmFudDtcclxuICAgICAgfSkuY2F0Y2goKGNhbGxiYWNrKT0+IHtcclxuICAgICAgXHJcbiAgICAgICAgREJIZWxwZXIuZmV0Y2hSZXN0YXVyYW50cyhjYWxsYmFjayA9PiB7XHJcbiAgICAgICByZXR1cm4gZGJQcm9taXNlLnRoZW4oZGIgPT4ge1xyXG4gICAgICAgICAgICBjb25zdCB0eCA9IGRiLnRyYW5zYWN0aW9uKCdyZXN0YXVyYW50LXN0b3JlJywgJ3JlYWR3cml0ZScpO1xyXG4gICAgICAgXHJcbiAgICAgICAgICAgIGNvbnN0IHJlc3RhdXJhbnRTdG9yZSA9IHR4Lm9iamVjdFN0b3JlKCdyZXN0YXVyYW50LXN0b3JlJyk7XHJcbiAgICAgICAgICAgIGNvbnN0IGluZGV4ID0gcmVzdGF1cmFudFN0b3JlLmluZGV4KCdyZXN0YXVyYW50SW5kZXgnLCAncmVhZHdyaXRlJyk7XHJcbiAgICAgICAgICAgIGNvbnN0IGZhdnMgPSAgaW5kZXguZ2V0QWxsKCdpc19mYXZvcml0ZScpO1xyXG4gICAgICAgICAgIFxyXG4gICAgICAgICAgICBjb25zb2xlLmxvZyhudWxsLCBmYXZzKTsgXHJcbiAgICAgICAgICAgcmV0dXJuIGNhbGxiYWNrKG51bGwsIGZhdnMpO1xyXG4gICAgICAgICB9KTtcclxuICAgICAgICB9KTsgXHJcbiAgICAgIGNvbnNvbGUubG9nKHJlc3RhdXJhbnQuaXNfZmF2b3JpdGUpO1xyXG4gICAgICByZXR1cm4gcmVzdGF1cmFudC5pc19mYXZvcml0ZTtcclxuICAgIH0pXHJcbiAgfVxyXG4gXHJcbil9XHJcblxyXG4gIC8qKlxyXG4gICAqIE1hcCBtYXJrZXIgZm9yIGEgcmVzdGF1cmFudC5cclxuICAgKi9cclxuICBzdGF0aWMgbWFwTWFya2VyRm9yUmVzdGF1cmFudChyZXN0YXVyYW50LCBtYXApIHtcclxuICAgIC8vIGh0dHBzOi8vbGVhZmxldGpzLmNvbS9yZWZlcmVuY2UtMS4zLjAuaHRtbCNtYXJrZXIgIFxyXG4gICAgY29uc3QgbWFya2VyID0gbmV3IEwubWFya2VyKFtyZXN0YXVyYW50LmxhdGxuZy5sYXQsIHJlc3RhdXJhbnQubGF0bG5nLmxuZ10sXHJcbiAgICAgIHtcclxuICAgICAgICB0aXRsZTogcmVzdGF1cmFudC5uYW1lLFxyXG4gICAgICAgIGFsdDogcmVzdGF1cmFudC5uYW1lLFxyXG4gICAgICAgIHVybDogREJIZWxwZXIudXJsRm9yUmVzdGF1cmFudChyZXN0YXVyYW50KVxyXG4gICAgICB9KVxyXG4gICAgbWFya2VyLmFkZFRvKG5ld01hcCk7XHJcbiAgICByZXR1cm4gbWFya2VyO1xyXG4gIH1cclxuXHJcbiAgLyogc3RhdGljIG1hcE1hcmtlckZvclJlc3RhdXJhbnQocmVzdGF1cmFudCwgbWFwKSB7XHJcbiAgICBjb25zdCBtYXJrZXIgPSBuZXcgZ29vZ2xlLm1hcHMuTWFya2VyKHtcclxuICAgICAgcG9zaXRpb246IHJlc3RhdXJhbnQubGF0bG5nLFxyXG4gICAgICB0aXRsZTogcmVzdGF1cmFudC5uYW1lLFxyXG4gICAgICB1cmw6IERCSGVscGVyLnVybEZvclJlc3RhdXJhbnQocmVzdGF1cmFudCksXHJcbiAgICAgIG1hcDogbWFwLFxyXG4gICAgICBhbmltYXRpb246IGdvb2dsZS5tYXBzLkFuaW1hdGlvbi5EUk9QfVxyXG4gICAgKTtcclxuICAgIHJldHVybiBtYXJrZXI7XHJcbiAgfSAqL1xyXG5cclxufVxyXG5cclxuIl19
