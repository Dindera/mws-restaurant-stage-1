const dbPromise=idb.open("restaurant-db",4,function(e){switch(e.oldVersion){case 0:e.createObjectStore("restaurant-store",{keyPath:"id"}).createIndex("restaurantIndex","is_favorite");case 1:e.createObjectStore("review-store",{keyPath:"id"}).createIndex("reviewIndex","restaurant_id"),e.createObjectStore("favorite-store",{keyPath:"is_favorite"});case 2:e.createObjectStore("offline-store",{keyPath:"id",autoIncrement:!0})}});class DBHelper{static get DATABASE_URL(){return"http://localhost:1337"}static fetchRestaurants(e){function t(){dbPromise.then(e=>e.transaction("restaurant-store").objectStore("restaurant-store").getAll()).then(t=>e(null,t))}fetch(`${DBHelper.DATABASE_URL}/restaurants/`).then(function(e){return e.json()}).then(e=>(dbPromise.then(t=>{const r=t.transaction("restaurant-store","readwrite"),n=r.objectStore("restaurant-store");for(const t of e)n.put(t);return r.complete}),e)).then(function(t){return e(null,t)}).catch(()=>t())}static fetchReviews(e,t){function r(){dbPromise.then(t=>t.transaction("review-store").objectStore("review-store").index("reviewIndex").getAll(IDBKeyRange.only(+e))).then(e=>(console.log(null,e),t(null,e)))}fetch(`${DBHelper.DATABASE_URL}/reviews/?restaurant_id=${+e}`).then(function(e){return e.json()}).then(e=>(dbPromise.then(t=>{const r=t.transaction("review-store","readwrite"),n=r.objectStore("review-store");for(const t of e)n.put(t);return r.complete}),e)).then(function(e){return t(null,e)}).catch(()=>r())}static fetchRestaurantById(e,t){DBHelper.fetchRestaurants((r,n)=>{if(r)t(r,null);else{const r=n.find(t=>t.id==e);r?t(null,r):t("Restaurant does not exist",null)}})}static fetchReviewById(e,t){DBHelper.fetchReviews((r,n)=>{if(r)t(r,null);else{const r=n.find(t=>t.id==e);r?t(null,r):t("Review does not exist",null)}})}static fetchRestaurantByCuisine(e,t){DBHelper.fetchRestaurants((r,n)=>{if(r)t(r,null);else{const r=n.filter(t=>t.cuisine_type==e);t(null,r)}})}static fetchRestaurantByNeighborhood(e,t){DBHelper.fetchRestaurants((r,n)=>{if(r)t(r,null);else{const r=n.filter(t=>t.neighborhood==e);t(null,r)}})}static fetchRestaurantByCuisineAndNeighborhood(e,t,r){DBHelper.fetchRestaurants((n,s)=>{if(n)r(n,null);else{let n=s;"all"!=e&&(n=n.filter(t=>t.cuisine_type==e)),"all"!=t&&(n=n.filter(e=>e.neighborhood==t)),r(null,n)}})}static fetchNeighborhoods(e){DBHelper.fetchRestaurants((t,r)=>{if(t)e(t,null);else{const t=r.map((e,t)=>r[t].neighborhood),n=t.filter((e,r)=>t.indexOf(e)==r);e(null,n)}})}static fetchCuisines(e){DBHelper.fetchRestaurants((t,r)=>{if(t)e(t,null);else{const t=r.map((e,t)=>r[t].cuisine_type),n=t.filter((e,r)=>t.indexOf(e)==r);e(null,n)}})}static urlForRestaurant(e){return`./restaurant.html?id=${e.id}`}static imageUrlForRestaurant(e){return`/src/img/${e.id}-300_small.jpg`}static imageSrcsetForIndex(e){return`src/images/${e.id}-300_small.jpg 1x, src/images/${e.id}-600_medium_2x.jpg 2x`}static imageSrcsetForRestaurant(e){return`src/images/${e.id}-300_small.jpg 300w, src/images/${e.id}-600_medium_2x.jpg 600w, src/images/${e.id}-800_large_2x.jpg 800w`}static saveFavorite(e,t){const r=`${DBHelper.DATABASE_URL}/restaurants/${e}/?is_favorite=${t}`;DBHelper.fetchRestaurantById(e,(e,n)=>{e||(n.is_favorite=t,console.log(t),dbPromise.then(e=>{const s=e.transaction("restaurant-store","readwrite");return s.objectStore("restaurant-store").put(n).then(e=>{console.log(s),console.log(t),console.log(r),console.log(n.is_favorite),fetch(r,{method:"PUT"})}),s.complete&&n}).catch(()=>(DBHelper.fetchRestaurants(e=>dbPromise.then(t=>{const r=t.transaction("restaurant-store").objectStore("restaurant-store").index("restaurantIndex").getAll("is_favorite");return console.log(null,r),e(null,r)})),console.log(n.is_favorite),n.is_favorite)))})}static mapMarkerForRestaurant(e,t){const r=new L.marker([e.latlng.lat,e.latlng.lng],{title:e.name,alt:e.name,url:DBHelper.urlForRestaurant(e)});return r.addTo(newMap),r}}
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImRiaGVscGVyLmpzIl0sIm5hbWVzIjpbImRiUHJvbWlzZSIsImlkYiIsIm9wZW4iLCJ1cGdyYWRlREIiLCJrZXlQYXRoIiwib2xkVmVyc2lvbiIsImNyZWF0ZUluZGV4IiwiY3JlYXRlT2JqZWN0U3RvcmUiLCJyZXZpZXdTdG9yZSIsImF1dG9JbmNyZW1lbnQiLCJEQkhlbHBlciIsIkRBVEFCQVNFX1VSTCIsIltvYmplY3QgT2JqZWN0XSIsImNhbGxiYWNrIiwiZnVsZmlsbFJlc3VsdCIsInRoZW4iLCJkYiIsImZldGNoUmVzdGF1cmFudHMiLCJvYmplY3RTdG9yZSIsInJlc3RhdXJhbnRzIiwiZmV0Y2giLCJyZXNwb25zZSIsImpzb24iLCJ0eCIsInRyYW5zYWN0aW9uIiwicmVzdGF1cmFudFN0b3JlIiwicmVzdGF1cmFudCIsImNvbXBsZXRlIiwiaWQiLCJkaXNwbGF5UmVzdWx0IiwiZ2V0RGJSZXZpZXciLCJnZXRBbGwiLCJJREJLZXlSYW5nZSIsIm9ubHkiLCJyZXZpZXdzIiwiY29uc29sZSIsInJldmlldyIsImVycm9yIiwiZmV0Y2hSZXN0YXVyYW50QnlJZCIsImZpbmQiLCJyIiwiY2IiLCJmZXRjaFJldmlld3MiLCJmZXRjaFJldmlld0J5SWQiLCJjdWlzaW5lIiwicmVzdWx0cyIsImZpbHRlciIsImN1aXNpbmVfdHlwZSIsIm5laWdoYm9yaG9vZCIsImZldGNoUmVzdGF1cmFudEJ5Q3Vpc2luZUFuZE5laWdoYm9yaG9vZCIsInVuaXF1ZU5laWdoYm9yaG9vZHMiLCJuZWlnaGJvcmhvb2RzIiwidiIsImkiLCJpbmRleE9mIiwiY3Vpc2luZXMiLCJtYXAiLCJ1bmlxdWVDdWlzaW5lcyIsImlzZmF2b3JpdGUiLCJ1cmwiLCJpc19mYXZvcml0ZSIsImltYWdlU3Jjc2V0Rm9yUmVzdGF1cmFudCIsInB1dCIsImxvZyIsIm1ldGhvZCIsImNhdGNoIiwiZmF2cyIsImluZGV4IiwiTCIsIm1hcmtlciIsImxhdGxuZyIsImxhdCIsImxuZyIsInRpdGxlIiwi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QUFDLFFBSkZSIiwiZmlsZSI6ImRiaGVscGVyLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLy8gZXhwb3J0IGRlZmF1bHQgREJIZWxwZXJcclxuXHJcblxyXG4oZnVuY3Rpb24gKCkge1xyXG4gICd1c2Ugc3RyaWN0J1xyXG5cclxuICBpZiAoISgnaW5kZXhlZERCJyBpbiB3aW5kb3cpKSB7XHJcbiAgICBjb25zb2xlLmxvZygnVGhpcyBicm93c2VyIGRvZXNuXFwndCBzdXBwb3J0IEluZGV4ZWREQicpO1xyXG4gICAgcmV0dXJuO1xyXG4gIH1cclxufSk7XHJcblxyXG5jb25zdCBkYlByb21pc2UgPSBpZGIub3BlbigncmVzdGF1cmFudC1kYicsIDQsIGZ1bmN0aW9uICh1cGdyYWRlREIpIHtcclxuXHJcbiAgc3dpdGNoICh1cGdyYWRlREIub2xkVmVyc2lvbikge1xyXG4gICAgY2FzZSAwOlxyXG4gICAgIGxldCByZXN0YXVyYW50U3RvcmUgPSAgdXBncmFkZURCLmNyZWF0ZU9iamVjdFN0b3JlKCdyZXN0YXVyYW50LXN0b3JlJywgeyBrZXlQYXRoOiAnaWQnIH0pO1xyXG4gICAgIHJlc3RhdXJhbnRTdG9yZS5jcmVhdGVJbmRleCgncmVzdGF1cmFudEluZGV4JywgJ2lzX2Zhdm9yaXRlJyk7XHJcbiAgICAgY2FzZSAxOlxyXG4gICAgICBsZXQgcmV2aWV3U3RvcmUgPSB1cGdyYWRlREIuY3JlYXRlT2JqZWN0U3RvcmUoJ3Jldmlldy1zdG9yZScsIHsga2V5UGF0aDogJ2lkJyB9KTtcclxuICAgICAgcmV2aWV3U3RvcmUuY3JlYXRlSW5kZXgoJ3Jldmlld0luZGV4JywgJ3Jlc3RhdXJhbnRfaWQnKTtcclxuICAgICAgdXBncmFkZURCLmNyZWF0ZU9iamVjdFN0b3JlKCdmYXZvcml0ZS1zdG9yZScsIHsga2V5UGF0aDogJ2lzX2Zhdm9yaXRlJyB9KTtcclxuICAgICAgY2FzZSAyOiBcclxuICAgICAgdXBncmFkZURCLmNyZWF0ZU9iamVjdFN0b3JlKCdvZmZsaW5lLXN0b3JlJywge2tleVBhdGg6ICdpZCcsIGF1dG9JbmNyZW1lbnQ6IHRydWV9KTtcclxuXHJcbiAgfVxyXG5cclxufSk7XHJcblxyXG4vKipcclxuICogQ29tbW9uIGRhdGFiYXNlIGhlbHBlciBmdW5jdGlvbnMuXHJcbiAqL1xyXG5jbGFzcyBEQkhlbHBlciB7XHJcbiAgLyoqXHJcbiAgICAgKiBEYXRhYmFzZSBVUkwuXHJcbiAgICAgKiBDaGFuZ2UgdGhpcyB0byByZXN0YXVyYW50cy5qc29uIGZpbGUgbG9jYXRpb24gb24geW91ciBzZXJ2ZXIuXHJcbiAgICAgKi9cclxuICBzdGF0aWMgZ2V0IERBVEFCQVNFX1VSTCgpIHtcclxuICAgIGNvbnN0IHBvcnQgPSAxMzM3IC8vIENoYW5nZSB0aGlzIHRvIHlvdXIgc2VydmVyIHBvcnRcclxuXHJcbiAgICByZXR1cm4gYGh0dHA6Ly9sb2NhbGhvc3Q6JHtwb3J0fWA7XHJcblxyXG4gICAgLy8gcmV0dXJuIGBodHRwczovL2RpbmRlcmEuZ2l0aHViLmlvLyR7cG9ydH0vZGF0YS9yZXN0YXVyYW50cy5qc29uYDtcclxuICB9XHJcblxyXG5cclxuICAvKipcclxuICAgKiBGZXRjaCBhbGwgcmVzdGF1cmFudHMuXHJcbiAgICovXHJcblxyXG4gIHN0YXRpYyBmZXRjaFJlc3RhdXJhbnRzKGNhbGxiYWNrKSB7XHJcbiAgICBmdW5jdGlvbiBnZXREYkRhdGEoKSB7XHJcbiAgICAgIHJldHVybiBkYlByb21pc2UudGhlbihkYiA9PiB7XHJcbiAgICAgICAgY29uc3QgdHggPSBkYi50cmFuc2FjdGlvbigncmVzdGF1cmFudC1zdG9yZScpXHJcbiAgICAgICAgICAub2JqZWN0U3RvcmUoJ3Jlc3RhdXJhbnQtc3RvcmUnKTtcclxuICAgICAgICByZXR1cm4gdHguZ2V0QWxsKCk7XHJcbiAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIGZ1bGZpbGxSZXN1bHQoKSB7XHJcbiAgICAgIGdldERiRGF0YSgpLnRoZW4ocmVzdGF1cmFudHMgPT4ge1xyXG4gICAgICAgIHJldHVybiBjYWxsYmFjayhudWxsLCByZXN0YXVyYW50cyk7XHJcbiAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuXHJcbiAgICBmZXRjaChgJHtEQkhlbHBlci5EQVRBQkFTRV9VUkx9L3Jlc3RhdXJhbnRzL2ApXHJcbiAgICAgIC50aGVuKGZ1bmN0aW9uIChyZXNwb25zZSkge1xyXG4gICAgICAgIGNvbnN0IHJlc3RhdXJhbnRzID0gcmVzcG9uc2UuanNvbigpO1xyXG4gICAgICAgIHJldHVybiByZXN0YXVyYW50cztcclxuICAgICAgfSkudGhlbihyZXN0YXVyYW50cyA9PiB7XHJcbiAgICAgICAgZGJQcm9taXNlLnRoZW4oZGIgPT4ge1xyXG4gICAgICAgICAgY29uc3QgdHggPSBkYi50cmFuc2FjdGlvbigncmVzdGF1cmFudC1zdG9yZScsICdyZWFkd3JpdGUnKTtcclxuICAgICAgICAgIGNvbnN0IHJlc3RhdXJhbnRTdG9yZSA9IHR4Lm9iamVjdFN0b3JlKCdyZXN0YXVyYW50LXN0b3JlJyk7XHJcbiAgICAgICAgICBmb3IgKGNvbnN0IHJlc3RhdXJhbnQgb2YgcmVzdGF1cmFudHMpIHtcclxuICAgICAgICAgICAgcmVzdGF1cmFudFN0b3JlLnB1dChyZXN0YXVyYW50KTtcclxuICAgICAgICAgIH1cclxuICAgICAgICAgIHJldHVybiB0eC5jb21wbGV0ZTtcclxuICAgICAgICB9KVxyXG4gICAgICAgIHJldHVybiByZXN0YXVyYW50cztcclxuICAgICAgfSkudGhlbihmdW5jdGlvbiAocmVzdGF1cmFudHMpIHtcclxuICAgICAgICByZXR1cm4gY2FsbGJhY2sobnVsbCwgcmVzdGF1cmFudHMpO1xyXG4gICAgICB9KS5jYXRjaCgoKSA9PiB7XHJcbiAgICAgICAgcmV0dXJuIGZ1bGZpbGxSZXN1bHQoKTtcclxuICAgICAgfSk7XHJcbiAgfVxyXG5cclxuICBzdGF0aWMgZmV0Y2hSZXZpZXdzKGlkLCBjYWxsYmFjaykge1xyXG5cclxuICAgIGZ1bmN0aW9uIGdldERiUmV2aWV3KCkge1xyXG4gICAgICByZXR1cm4gZGJQcm9taXNlLnRoZW4oZGIgPT4ge1xyXG4gICAgICAgIGNvbnN0IHR4ID0gZGIudHJhbnNhY3Rpb24oJ3Jldmlldy1zdG9yZScpXHJcbiAgICAgICAgY29uc3QgcmV2aWV3U3RvcmUgPSB0eC5vYmplY3RTdG9yZSgncmV2aWV3LXN0b3JlJyk7XHJcbiAgICAgICAgY29uc3QgaW5kZXggPSByZXZpZXdTdG9yZS5pbmRleCgncmV2aWV3SW5kZXgnKTtcclxuICAgICAgICAvLyBnZXQgcmVzdGF1cmFudF9pZCBvZiBhIHNwZWNpZmljIG51bWJlclxyXG4gICAgICAgIHJldHVybiBpbmRleC5nZXRBbGwoSURCS2V5UmFuZ2Uub25seSgraWQpKTsgXHJcbiAgICAgIH0pO1xyXG4gICAgfVxyXG4gICAgLy8gZGlzcGxheSB0aGUgcmV2aWV3cyB3aGVuIG9mZmxpbmVcclxuICAgIGZ1bmN0aW9uIGRpc3BsYXlSZXN1bHQoKSB7XHJcbiAgICAgIGdldERiUmV2aWV3KCkudGhlbihyZXZpZXdzID0+IHtcclxuICAgICAgICBjb25zb2xlLmxvZyhudWxsLCByZXZpZXdzKVxyXG4gICAgICAgIHJldHVybiBjYWxsYmFjayhudWxsLCByZXZpZXdzKTtcclxuICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG5cclxuICAgIGZldGNoKGAke0RCSGVscGVyLkRBVEFCQVNFX1VSTH0vcmV2aWV3cy8/cmVzdGF1cmFudF9pZD0keytpZH1gKVxyXG4gICAgICAudGhlbihmdW5jdGlvbiAocmVzcG9uc2UpIHtcclxuICAgICAgICBjb25zdCByZXZpZXdzID0gcmVzcG9uc2UuanNvbigpO1xyXG4gICAgICAgIHJldHVybiByZXZpZXdzO1xyXG4gICAgICB9KS50aGVuKHJldmlld3MgPT4ge1xyXG4gICAgICAgIGRiUHJvbWlzZS50aGVuKGRiID0+IHtcclxuICAgICAgICAgIC8vc2F2ZSByZXZpZXdzIGluIGRiXHJcbiAgICAgICAgICBjb25zdCB0eCA9IGRiLnRyYW5zYWN0aW9uKCdyZXZpZXctc3RvcmUnLCAncmVhZHdyaXRlJyk7XHJcbiAgICAgICAgICBjb25zdCByZXZpZXdTdG9yZSA9IHR4Lm9iamVjdFN0b3JlKCdyZXZpZXctc3RvcmUnKTtcclxuICAgICAgICAgIGZvciAoY29uc3QgcmV2aWV3IG9mIHJldmlld3MpIHtcclxuICAgICAgICAgICAgcmV2aWV3U3RvcmUucHV0KHJldmlldyk7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgICByZXR1cm4gdHguY29tcGxldGU7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgcmV0dXJuIHJldmlld3M7XHJcbiAgICAgIH0pLnRoZW4oZnVuY3Rpb24gKHJldmlld3MpIHtcclxuICAgICAgICByZXR1cm4gY2FsbGJhY2sobnVsbCwgcmV2aWV3cyk7XHJcbiAgICAgIH0pLmNhdGNoKCgpID0+IHtcclxuICAgICAgICByZXR1cm4gZGlzcGxheVJlc3VsdCgpO1xyXG4gICAgICB9KTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIEZldGNoIGEgcmVzdGF1cmFudCBieSBpdHMgSUQuXHJcbiAgICovXHJcbiAgc3RhdGljIGZldGNoUmVzdGF1cmFudEJ5SWQoaWQsIGNhbGxiYWNrKSB7XHJcbiAgICAvLyBmZXRjaCBhbGwgcmVzdGF1cmFudHMgd2l0aCBwcm9wZXIgZXJyb3IgaGFuZGxpbmcuXHJcbiAgICBEQkhlbHBlci5mZXRjaFJlc3RhdXJhbnRzKChlcnJvciwgcmVzdGF1cmFudHMpID0+IHtcclxuICAgICAgaWYgKGVycm9yKSB7XHJcbiAgICAgICAgY2FsbGJhY2soZXJyb3IsIG51bGwpO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIGNvbnN0IHJlc3RhdXJhbnQgPSByZXN0YXVyYW50cy5maW5kKHIgPT4gci5pZCA9PSBpZCk7XHJcbiAgICAgICAgaWYgKHJlc3RhdXJhbnQpIHsgLy8gR290IHRoZSByZXN0YXVyYW50XHJcbiAgICAgICAgICBjYWxsYmFjayhudWxsLCByZXN0YXVyYW50KTtcclxuICAgICAgICB9IGVsc2UgeyAvLyBSZXN0YXVyYW50IGRvZXMgbm90IGV4aXN0IGluIHRoZSBkYXRhYmFzZVxyXG4gICAgICAgICAgY2FsbGJhY2soJ1Jlc3RhdXJhbnQgZG9lcyBub3QgZXhpc3QnLCBudWxsKTtcclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAqIEZldGNoIGEgcmV2aWV3IGJ5IGl0cyBJRC5cclxuICovXHJcbiAgc3RhdGljIGZldGNoUmV2aWV3QnlJZChpZCwgY2IpIHtcclxuICAgIC8vIGZldGNoIGFsbCByZXZpZXdzIHdpdGggcHJvcGVyIGVycm9yIGhhbmRsaW5nLlxyXG4gICAgREJIZWxwZXIuZmV0Y2hSZXZpZXdzKChlcnJvciwgcmV2aWV3cykgPT4ge1xyXG4gICAgICBpZiAoZXJyb3IpIHtcclxuICAgICAgICBjYihlcnJvciwgbnVsbCk7XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgY29uc3QgcmV2aWV3ID0gcmV2aWV3cy5maW5kKHIgPT4gci5pZCA9PSBpZCk7XHJcbiAgICAgICAgaWYgKHJldmlldykgeyAvLyBHb3QgdGhlIHJldmlld1xyXG4gICAgICAgICAgY2IobnVsbCwgcmV2aWV3KTtcclxuICAgICAgICB9IGVsc2UgeyAvLyBSZXN0YXVyYW50IGRvZXMgbm90IGV4aXN0IGluIHRoZSBkYXRhYmFzZVxyXG4gICAgICAgICAgY2IoJ1JldmlldyBkb2VzIG5vdCBleGlzdCcsIG51bGwpO1xyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBGZXRjaCByZXN0YXVyYW50cyBieSBhIGN1aXNpbmUgdHlwZSB3aXRoIHByb3BlciBlcnJvciBoYW5kbGluZy5cclxuICAgKi9cclxuICBzdGF0aWMgZmV0Y2hSZXN0YXVyYW50QnlDdWlzaW5lKGN1aXNpbmUsIGNhbGxiYWNrKSB7XHJcbiAgICAvLyBGZXRjaCBhbGwgcmVzdGF1cmFudHMgIHdpdGggcHJvcGVyIGVycm9yIGhhbmRsaW5nXHJcbiAgICBEQkhlbHBlci5mZXRjaFJlc3RhdXJhbnRzKChlcnJvciwgcmVzdGF1cmFudHMpID0+IHtcclxuICAgICAgaWYgKGVycm9yKSB7XHJcbiAgICAgICAgY2FsbGJhY2soZXJyb3IsIG51bGwpO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIC8vIEZpbHRlciByZXN0YXVyYW50cyB0byBoYXZlIG9ubHkgZ2l2ZW4gY3Vpc2luZSB0eXBlXHJcbiAgICAgICAgY29uc3QgcmVzdWx0cyA9IHJlc3RhdXJhbnRzLmZpbHRlcihyID0+IHIuY3Vpc2luZV90eXBlID09IGN1aXNpbmUpO1xyXG4gICAgICAgIGNhbGxiYWNrKG51bGwsIHJlc3VsdHMpO1xyXG4gICAgICB9XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIEZldGNoIHJlc3RhdXJhbnRzIGJ5IGEgbmVpZ2hib3Job29kIHdpdGggcHJvcGVyIGVycm9yIGhhbmRsaW5nLlxyXG4gICAqL1xyXG4gIHN0YXRpYyBmZXRjaFJlc3RhdXJhbnRCeU5laWdoYm9yaG9vZChuZWlnaGJvcmhvb2QsIGNhbGxiYWNrKSB7XHJcbiAgICAvLyBGZXRjaCBhbGwgcmVzdGF1cmFudHNcclxuICAgIERCSGVscGVyLmZldGNoUmVzdGF1cmFudHMoKGVycm9yLCByZXN0YXVyYW50cykgPT4ge1xyXG4gICAgICBpZiAoZXJyb3IpIHtcclxuICAgICAgICBjYWxsYmFjayhlcnJvciwgbnVsbCk7XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgLy8gRmlsdGVyIHJlc3RhdXJhbnRzIHRvIGhhdmUgb25seSBnaXZlbiBuZWlnaGJvcmhvb2RcclxuICAgICAgICBjb25zdCByZXN1bHRzID0gcmVzdGF1cmFudHMuZmlsdGVyKHIgPT4gci5uZWlnaGJvcmhvb2QgPT0gbmVpZ2hib3Job29kKTtcclxuICAgICAgICBjYWxsYmFjayhudWxsLCByZXN1bHRzKTtcclxuICAgICAgfVxyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBGZXRjaCByZXN0YXVyYW50cyBieSBhIGN1aXNpbmUgYW5kIGEgbmVpZ2hib3Job29kIHdpdGggcHJvcGVyIGVycm9yIGhhbmRsaW5nLlxyXG4gICAqL1xyXG4gIHN0YXRpYyBmZXRjaFJlc3RhdXJhbnRCeUN1aXNpbmVBbmROZWlnaGJvcmhvb2QoY3Vpc2luZSwgbmVpZ2hib3Job29kLCBjYWxsYmFjaykge1xyXG4gICAgLy8gRmV0Y2ggYWxsIHJlc3RhdXJhbnRzXHJcbiAgICBEQkhlbHBlci5mZXRjaFJlc3RhdXJhbnRzKChlcnJvciwgcmVzdGF1cmFudHMpID0+IHtcclxuICAgICAgaWYgKGVycm9yKSB7XHJcbiAgICAgICAgY2FsbGJhY2soZXJyb3IsIG51bGwpO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIGxldCByZXN1bHRzID0gcmVzdGF1cmFudHNcclxuICAgICAgICBpZiAoY3Vpc2luZSAhPSAnYWxsJykgeyAvLyBmaWx0ZXIgYnkgY3Vpc2luZVxyXG4gICAgICAgICAgcmVzdWx0cyA9IHJlc3VsdHMuZmlsdGVyKHIgPT4gci5jdWlzaW5lX3R5cGUgPT0gY3Vpc2luZSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmIChuZWlnaGJvcmhvb2QgIT0gJ2FsbCcpIHsgLy8gZmlsdGVyIGJ5IG5laWdoYm9yaG9vZFxyXG4gICAgICAgICAgcmVzdWx0cyA9IHJlc3VsdHMuZmlsdGVyKHIgPT4gci5uZWlnaGJvcmhvb2QgPT0gbmVpZ2hib3Job29kKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgY2FsbGJhY2sobnVsbCwgcmVzdWx0cyk7XHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogRmV0Y2ggYWxsIG5laWdoYm9yaG9vZHMgd2l0aCBwcm9wZXIgZXJyb3IgaGFuZGxpbmcuXHJcbiAgICovXHJcbiAgc3RhdGljIGZldGNoTmVpZ2hib3Job29kcyhjYWxsYmFjaykge1xyXG4gICAgLy8gRmV0Y2ggYWxsIHJlc3RhdXJhbnRzXHJcbiAgICBEQkhlbHBlci5mZXRjaFJlc3RhdXJhbnRzKChlcnJvciwgcmVzdGF1cmFudHMpID0+IHtcclxuICAgICAgaWYgKGVycm9yKSB7XHJcbiAgICAgICAgY2FsbGJhY2soZXJyb3IsIG51bGwpO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIC8vIEdldCBhbGwgbmVpZ2hib3Job29kcyBmcm9tIGFsbCByZXN0YXVyYW50c1xyXG4gICAgICAgIGNvbnN0IG5laWdoYm9yaG9vZHMgPSByZXN0YXVyYW50cy5tYXAoKHYsIGkpID0+IHJlc3RhdXJhbnRzW2ldLm5laWdoYm9yaG9vZClcclxuICAgICAgICAvLyBSZW1vdmUgZHVwbGljYXRlcyBmcm9tIG5laWdoYm9yaG9vZHNcclxuICAgICAgICBjb25zdCB1bmlxdWVOZWlnaGJvcmhvb2RzID0gbmVpZ2hib3Job29kcy5maWx0ZXIoKHYsIGkpID0+IG5laWdoYm9yaG9vZHMuaW5kZXhPZih2KSA9PSBpKVxyXG4gICAgICAgIGNhbGxiYWNrKG51bGwsIHVuaXF1ZU5laWdoYm9yaG9vZHMpO1xyXG4gICAgICB9XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIEZldGNoIGFsbCBjdWlzaW5lcyB3aXRoIHByb3BlciBlcnJvciBoYW5kbGluZy5cclxuICAgKi9cclxuICBzdGF0aWMgZmV0Y2hDdWlzaW5lcyhjYWxsYmFjaykge1xyXG4gICAgLy8gRmV0Y2ggYWxsIHJlc3RhdXJhbnRzXHJcbiAgICBEQkhlbHBlci5mZXRjaFJlc3RhdXJhbnRzKChlcnJvciwgcmVzdGF1cmFudHMpID0+IHtcclxuICAgICAgaWYgKGVycm9yKSB7XHJcbiAgICAgICAgY2FsbGJhY2soZXJyb3IsIG51bGwpO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIC8vIEdldCBhbGwgY3Vpc2luZXMgZnJvbSBhbGwgcmVzdGF1cmFudHNcclxuICAgICAgICBjb25zdCBjdWlzaW5lcyA9IHJlc3RhdXJhbnRzLm1hcCgodiwgaSkgPT4gcmVzdGF1cmFudHNbaV0uY3Vpc2luZV90eXBlKVxyXG4gICAgICAgIC8vIFJlbW92ZSBkdXBsaWNhdGVzIGZyb20gY3Vpc2luZXNcclxuICAgICAgICBjb25zdCB1bmlxdWVDdWlzaW5lcyA9IGN1aXNpbmVzLmZpbHRlcigodiwgaSkgPT4gY3Vpc2luZXMuaW5kZXhPZih2KSA9PSBpKVxyXG4gICAgICAgIGNhbGxiYWNrKG51bGwsIHVuaXF1ZUN1aXNpbmVzKTtcclxuICAgICAgfVxyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBSZXN0YXVyYW50IHBhZ2UgVVJMLlxyXG4gICAqL1xyXG4gIHN0YXRpYyB1cmxGb3JSZXN0YXVyYW50KHJlc3RhdXJhbnQpIHtcclxuICAgIHJldHVybiAoYC4vcmVzdGF1cmFudC5odG1sP2lkPSR7cmVzdGF1cmFudC5pZH1gKTtcclxuICAgIC8vIGNvbnN0IHVybCA9ICdodHRwczovL2RpbmRlcmEuZ2l0aHViLmlvL3Jlc3RhdXJhbnQtcmV2aWV3LWFwcC8nO1xyXG4gICAgLy8gcmV0dXJuIChgL3Jlc3RhdXJhbnRzLyR7cmVzdGF1cmFudC5pZH1gKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIFJlc3RhdXJhbnQgaW1hZ2UgVVJMLlxyXG4gICAqL1xyXG4gIHN0YXRpYyBpbWFnZVVybEZvclJlc3RhdXJhbnQocmVzdGF1cmFudCkge1xyXG4gICAgcmV0dXJuIChgL3NyYy9pbWcvJHtyZXN0YXVyYW50LmlkfS0zMDBfc21hbGwuanBnYCk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAqICBJbWFnZSBTcmNzZXQgZm9yIEluZGV4IHBhZ2UuXHJcbiAgKi9cclxuICBzdGF0aWMgaW1hZ2VTcmNzZXRGb3JJbmRleChyZXN0YXVyYW50KSB7XHJcbiAgICByZXR1cm4gKGBzcmMvaW1hZ2VzLyR7cmVzdGF1cmFudC5pZH0tMzAwX3NtYWxsLmpwZyAxeCwgc3JjL2ltYWdlcy8ke3Jlc3RhdXJhbnQuaWR9LTYwMF9tZWRpdW1fMnguanBnIDJ4YCk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAqICBJbWFnZSBTcmNzZXQgZm9yIFJlc3RhdXJhbnQgcGFnZS5cclxuICAqL1xyXG4gIHN0YXRpYyBpbWFnZVNyY3NldEZvclJlc3RhdXJhbnQocmVzdGF1cmFudCkge1xyXG4gICAgcmV0dXJuIChgc3JjL2ltYWdlcy8ke3Jlc3RhdXJhbnQuaWR9LTMwMF9zbWFsbC5qcGcgMzAwdywgc3JjL2ltYWdlcy8ke3Jlc3RhdXJhbnQuaWR9LTYwMF9tZWRpdW1fMnguanBnIDYwMHcsIHNyYy9pbWFnZXMvJHtyZXN0YXVyYW50LmlkfS04MDBfbGFyZ2VfMnguanBnIDgwMHdgKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICogR2V0IEZhdm9yaXRlIHJlc3RhdXJhbnRzXHJcbiAgKiAvKlxyXG4qIE1hcmsgZmF2b3JpdGUgcmVzdGF1cmFudCBhbmQgYWRkIHRvIGZhdm9yaXRlIGRhdGFiYXNlIGFuZCByZXN0YXVyYW50IGRhdGFiYXNlXHJcbiogR2V0IHRoZSBmYXZvcml0ZXMgd2hlbiBvZmZsaW5lIGZyb20gcmVzdGF1cm50IGRhdGFic2UgXHJcbiogcHV0IGZhdm9yaXRlIHdoZW4gb2ZmbGluZSB0byBkYXRhYmFzZVxyXG4qIHNlbmQgZmF2b3JpdGVzIHRvIHNlcnZlciBmcm9tIGRhdGFiYXNlIHdoZW4gY29ubmVjdGVkIHRvIG5ldHdvcmtcclxuXHJcbiovXHJcblxyXG4gIHN0YXRpYyBzYXZlRmF2b3JpdGUoaWQsIGlzZmF2b3JpdGUsKSB7XHJcblxyXG4gIGNvbnN0IHVybCA9IGAke0RCSGVscGVyLkRBVEFCQVNFX1VSTH0vcmVzdGF1cmFudHMvJHtpZH0vP2lzX2Zhdm9yaXRlPSR7aXNmYXZvcml0ZX1gXHJcbiAgLy9jb25zdCBtZXRob2QgPSAnUFVUJztcclxuICAgICBcclxuICAgIC8vREJIZWxwZXIuYWRkUGVuZGluZ09mZmxpbmUodXJsLCBtZXRob2QpXHJcbiAgICBEQkhlbHBlci5mZXRjaFJlc3RhdXJhbnRCeUlkKGlkLCAoZXJyb3IsIHJlc3RhdXJhbnQpID0+IHtcclxuICAgICAgaWYoZXJyb3IpIHJldHVybjtcclxuICAgICAgcmVzdGF1cmFudC5pc19mYXZvcml0ZSA9IGlzZmF2b3JpdGU7XHJcbiAgICAgIGNvbnNvbGUubG9nKGlzZmF2b3JpdGUpO1xyXG4gICAgICBkYlByb21pc2UudGhlbihkYiA9PiB7XHJcbiAgICAgICAgY29uc3QgdHggPSBkYi50cmFuc2FjdGlvbigncmVzdGF1cmFudC1zdG9yZScsICdyZWFkd3JpdGUnKTtcclxuICAgICAgICBjb25zdCByZXN0YXVyYW50U3RvcmUgPSB0eC5vYmplY3RTdG9yZSgncmVzdGF1cmFudC1zdG9yZScpO1xyXG5cclxuICAgICAgICByZXN0YXVyYW50U3RvcmUucHV0KHJlc3RhdXJhbnQpLnRoZW4oaWQgPT4ge1xyXG4gICAgICAgICAgY29uc29sZS5sb2codHgpO1xyXG4gICAgICAgICAgY29uc29sZS5sb2coaXNmYXZvcml0ZSk7XHJcbiAgICAgICAgICBjb25zb2xlLmxvZyh1cmwpO1xyXG4gICAgICAgICAgY29uc29sZS5sb2cocmVzdGF1cmFudC5pc19mYXZvcml0ZSk7XHJcbiAgICAgICAgICBmZXRjaCh1cmwsIHtcclxuICAgICAgICAgICAgbWV0aG9kOiAnUFVUJ1xyXG4gICAgICAgICAgfSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgcmV0dXJuIHR4LmNvbXBsZXRlICYmIHJlc3RhdXJhbnQ7XHJcbiAgICAgIH0pLmNhdGNoKCgpPT4ge1xyXG4gICAgICBcclxuICAgICAgICBEQkhlbHBlci5mZXRjaFJlc3RhdXJhbnRzKGNhbGxiYWNrID0+IHtcclxuICAgICAgIHJldHVybiBkYlByb21pc2UudGhlbihkYiA9PiB7XHJcbiAgICAgICAgICAgIGNvbnN0IHR4ID0gZGIudHJhbnNhY3Rpb24oJ3Jlc3RhdXJhbnQtc3RvcmUnKVxyXG4gICAgICAgICAgICBjb25zdCByZXN0YXVyYW50U3RvcmUgPSB0eC5vYmplY3RTdG9yZSgncmVzdGF1cmFudC1zdG9yZScpO1xyXG4gICAgICAgICAgICBjb25zdCBpbmRleCA9IHJlc3RhdXJhbnRTdG9yZS5pbmRleCgncmVzdGF1cmFudEluZGV4Jyk7XHJcbiAgICAgICAgICAgIGNvbnN0IGZhdnMgPSAgaW5kZXguZ2V0QWxsKCdpc19mYXZvcml0ZScpO1xyXG4gICAgICAgICAgICBcclxuICAgICAgICAgICAgY29uc29sZS5sb2cobnVsbCwgZmF2cyk7IFxyXG4gICAgICAgICAgIHJldHVybiBjYWxsYmFjayhudWxsLCBmYXZzIClcclxuICAgICAgICAgfSk7XHJcbiAgICAgICAgfSk7IFxyXG4gICAgICBjb25zb2xlLmxvZyhyZXN0YXVyYW50LmlzX2Zhdm9yaXRlKTtcclxuICAgICAgcmV0dXJuIHJlc3RhdXJhbnQuaXNfZmF2b3JpdGU7XHJcbiAgICB9KVxyXG4gIH1cclxuIFxyXG4pfVxyXG5cclxuXHJcbiAgLyoqXHJcbiAgICogTWFwIG1hcmtlciBmb3IgYSByZXN0YXVyYW50LlxyXG4gICAqL1xyXG4gIHN0YXRpYyBtYXBNYXJrZXJGb3JSZXN0YXVyYW50KHJlc3RhdXJhbnQsIG1hcCkge1xyXG4gICAgLy8gaHR0cHM6Ly9sZWFmbGV0anMuY29tL3JlZmVyZW5jZS0xLjMuMC5odG1sI21hcmtlciAgXHJcbiAgICBjb25zdCBtYXJrZXIgPSBuZXcgTC5tYXJrZXIoW3Jlc3RhdXJhbnQubGF0bG5nLmxhdCwgcmVzdGF1cmFudC5sYXRsbmcubG5nXSxcclxuICAgICAge1xyXG4gICAgICAgIHRpdGxlOiByZXN0YXVyYW50Lm5hbWUsXHJcbiAgICAgICAgYWx0OiByZXN0YXVyYW50Lm5hbWUsXHJcbiAgICAgICAgdXJsOiBEQkhlbHBlci51cmxGb3JSZXN0YXVyYW50KHJlc3RhdXJhbnQpXHJcbiAgICAgIH0pXHJcbiAgICBtYXJrZXIuYWRkVG8obmV3TWFwKTtcclxuICAgIHJldHVybiBtYXJrZXI7XHJcbiAgfVxyXG5cclxuICAvKiBzdGF0aWMgbWFwTWFya2VyRm9yUmVzdGF1cmFudChyZXN0YXVyYW50LCBtYXApIHtcclxuICAgIGNvbnN0IG1hcmtlciA9IG5ldyBnb29nbGUubWFwcy5NYXJrZXIoe1xyXG4gICAgICBwb3NpdGlvbjogcmVzdGF1cmFudC5sYXRsbmcsXHJcbiAgICAgIHRpdGxlOiByZXN0YXVyYW50Lm5hbWUsXHJcbiAgICAgIHVybDogREJIZWxwZXIudXJsRm9yUmVzdGF1cmFudChyZXN0YXVyYW50KSxcclxuICAgICAgbWFwOiBtYXAsXHJcbiAgICAgIGFuaW1hdGlvbjogZ29vZ2xlLm1hcHMuQW5pbWF0aW9uLkRST1B9XHJcbiAgICApO1xyXG4gICAgcmV0dXJuIG1hcmtlcjtcclxuICB9ICovXHJcblxyXG59XHJcblxyXG4iXX0=
